<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ACAMP 360º 2025 - Gestão de Tarefas</title>
    <link rel="shortcut icon" href="3.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            color: #333;
            padding-top: 80px;
        }

        .header {
            background: linear-gradient(45deg, #000000, #000000);
            padding: 20px;
            text-align: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            height: 80px;
        }

        .header-title {
            color: white;
        }

        .card {
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background: linear-gradient(45deg, #3d7517, #3d7517);
            color: white;
            font-weight: bold;
        }

        .progress {
            height: 25px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 15px;
        }

        .task-complete {
            text-decoration: line-through;
            color: #28a745;
        }

        .btn-acamp {
            background: linear-gradient(45deg, #3d7517, #3d7517);
            color: white;
            border: none;
        }

        .filter-card {
            background-color: #f8f9fa;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-bottom: 20px;
        }

        .badge-pago {
            background-color: #28a745;
        }

        .badge-pendente {
            background-color: #ffc107;
        }

        .badge-high {
            background-color: #dc3545;
        }

        .badge-medium {
            background-color: #ffc107;
        }

        .badge-low {
            background-color: #17a2b8;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .btn-voltar {
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.btn-voltar:hover {
    background-color: rgba(255, 255, 255, 0.3);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    transform: translateY(-50%) scale(1.05);
    color: white;
    text-decoration: none;
}

.btn-voltar .material-icons {
    font-size: 24px;
}
    </style>
</head>

<body>
    <div class="header">
        <a href="gestao.html" class="btn-voltar">
            <i class="material-icons">arrow_back</i>
        </a>
        <h2 class="header-title">GESTÃO DE TAREFAS - ACAMP 360º 2025</h2>
    </div>

    <div class="container mt-5">
        <div class="row">
            <div class="col-md-3">
                <div class="list-group">
                    <a href="#" class="list-group-item list-group-item-action active"
                        data-section="dashboard">Dashboard</a>
                    <a href="#" class="list-group-item list-group-item-action" data-section="checklist">Checklist</a>
                    <!--<a href="#" class="list-group-item list-group-item-action">Participantes</a>
                    <a href="#" class="list-group-item list-group-item-action">Configurações</a>-->
                </div>
            </div>

            <div class="col-md-9">
                <!-- Seção do Dashboard -->
                <div id="dashboard" class="content-section active">
                    <div class="card mb-4">
                        <div class="card-header">
                            Progresso Geral
                        </div>
                        <div class="card-body">
                            <div class="progress">
                                <div class="progress-bar bg-success" id="progressoGeral" role="progressbar"
                                    style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%
                                    Concluído</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    Departamentos
                                </div>
                                <div class="card-body">
                                    <ul class="list-group" id="listaDepartamentos">
                                        <!-- Os departamentos serão adicionados dinamicamente aqui -->
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    Tarefas Pendentes
                                </div>
                                <div class="card-body">
                                    <ul class="list-group" id="listaTarefasPendentes">
                                        <!-- As tarefas pendentes serão adicionadas dinamicamente aqui -->
                                    </ul>
                                    <div class="mt-3 text-center">
                                        <a href="#" class="btn btn-acamp" data-section="checklist"
                                            id="verTodasTarefas">Ver todas as tarefas</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header">
                            Estatísticas
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 text-center">
                                    <h3 id="totalTarefas">0</h3>
                                    <p>Total de Tarefas</p>
                                </div>
                                <div class="col-md-4 text-center">
                                    <h3 id="tarefasConcluidas">0</h3>
                                    <p>Tarefas Concluídas</p>
                                </div>
                                <div class="col-md-4 text-center">
                                    <h3 id="tarefasAtrasadas">0</h3>
                                    <p>Tarefas Atrasadas</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seção do Checklist -->
                <div id="checklist" class="content-section">
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <h3>Lista de Tarefas do Acampamento</h3>
                        </div>
                        <div class="col-md-4 text-right">
                            <button class="btn btn-acamp" data-toggle="modal" data-target="#addTaskModal">
                                <i class="bi bi-plus-circle"></i> Nova Tarefa
                            </button>
                        </div>
                    </div>

                    <div class="filter-card">
                        <form id="filterForm" class="row">
                            <div class="form-group col-md-3">
                                <label for="filterDepartamento">Departamento</label>
                                <select class="form-control" id="filterDepartamento">
                                    <option value="">Todos</option>
                                    <option value="Supervisão">Supervisão</option>
                                    <option value="Financeiro">Financeiro</option>
                                    <option value="Cronograma">Cronograma</option>
                                    <option value="Midia">Midia</option>
                                    <option value="MidiaFisica">Midia Fisica</option>
                                    <option value="Gincana">Gincana</option>
                                    <option value="Decoração">Decoração</option>
                                    <option value="Devocionais">Devocionais</option>
                                    <option value="Louvor">Louvor</option>
                                    <option value="CoberturaEspiritual">Cobertura Espiritual</option>
                                </select>
                            </div>
                            <div class="form-group col-md-3">
                                <label for="filterStatus">Status</label>
                                <select class="form-control" id="filterStatus">
                                    <option value="">Todos</option>
                                    <option value="todo">A Fazer</option>
                                    <option value="inProgress">Em Andamento</option>
                                    <option value="completed">Concluído</option>
                                </select>
                            </div>
                            <div class="form-group col-md-3">
                                <label for="filterPrioridade">Prioridade</label>
                                <select class="form-control" id="filterPrioridade">
                                    <option value="">Todas</option>
                                    <option value="high">Alta</option>
                                    <option value="medium">Média</option>
                                    <option value="low">Baixa</option>
                                </select>
                            </div>
                            <div class="form-group col-md-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="material-icons align-middle">search</i> Filtrar
                                </button>
                                <button type="button" class="btn btn-outline-secondary ml-2" id="limparFiltro">
                                    Limpar
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped" id="tarefasTable">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Título</th>
                                    <th>Departamento</th>
                                    <th>Responsável</th>
                                    <th>Vencimento</th>
                                    <th>Prioridade</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tarefasList">
                                <!-- Os dados serão carregados dinamicamente do Firebase -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar Tarefa -->
    <div class="modal fade" id="addTaskModal" tabindex="-1" role="dialog" aria-labelledby="addTaskModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTaskModalLabel">Adicionar Nova Tarefa</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="newTaskForm">
                        <div class="form-group">
                            <label for="taskDepartment">Departamento</label>
                            <select class="form-control" id="taskDepartment" required>
                                <option value="">Selecione um departamento</option>
                                <option value="Supervisão">Supervisão: Mozer e Marcielle</option>
                                <option value="Financeiro">Financeiro: Ana Clara</option>
                                <option value="Cronograma">Cronograma: Monique</option>
                                <option value="Midia">Midia: Rebekah</option>
                                <option value="MidiaFisica">Midia Fisica: Lívia</option>
                                <option value="Gincana">Gincana: Pedro / Felipe</option>
                                <option value="Decoração">Decoração: Amanda / Pietra / Lucas / Saymon</option>
                                <option value="Devocionais">Devocionais: Clóvis</option>
                                <option value="Louvor">Louvor: Mozer / Andrei / Nicoly E</option>
                                <option value="CoberturaEspiritual">Cobertura Espiritual</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="taskTitle">Título da Tarefa</label>
                            <input type="text" class="form-control" id="taskTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="taskDescription">Descrição</label>
                            <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="taskDueDate">Data de Vencimento</label>
                                <input type="date" class="form-control" id="taskDueDate" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="taskPriority">Prioridade</label>
                                <select class="form-control" id="taskPriority">
                                    <option value="low">Baixa</option>
                                    <option value="medium">Média</option>
                                    <option value="high">Alta</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="taskResponsible">Responsável</label>
                            <select class="form-control" id="taskResponsible">
                                <option value="">Selecione um responsável</option>
                                <option value="Mozer">Mozer</option>
                                <option value="Marcielle">Marcielle</option>
                                <option value="Ana Clara">Ana Clara</option>
                                <option value="Monique">Monique</option>
                                <option value="Rebekah">Rebekah</option>
                                <option value="Lívia">Lívia</option>
                                <option value="Pedro">Pedro</option>
                                <option value="Felipe">Felipe</option>
                                <option value="Amanda">Amanda</option>
                                <option value="Pietra">Pietra</option>
                                <option value="Lucas">Lucas</option>
                                <option value="Saymon">Saymon</option>
                                <option value="Clóvis">Clóvis</option>
                                <option value="Andrei">Andrei</option>
                                <option value="Nicoly E">Nicoly E</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveTaskBtn">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Tarefa -->
    <div class="modal fade" id="editTaskModal" tabindex="-1" role="dialog" aria-labelledby="editTaskModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editTaskModalLabel">Editar Tarefa</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editTaskForm">
                        <input type="hidden" id="editTaskId">
                        <div class="form-group">
                            <label for="editTaskDepartment">Departamento</label>
                            <select class="form-control" id="editTaskDepartment" required>
                                <option value="">Selecione um departamento</option>
                                <option value="Supervisão">Supervisão: Mozer e Marcielle</option>
                                <option value="Financeiro">Financeiro: Ana Clara</option>
                                <option value="Cronograma">Cronograma: Monique</option>
                                <option value="Midia">Midia: Rebekah</option>
                                <option value="MidiaFisica">Midia Fisica: Lívia</option>
                                <option value="Gincana">Gincana: Pedro / Felipe</option>
                                <option value="Decoração">Decoração: Amanda / Pietra / Lucas / Saymon</option>
                                <option value="Devocionais">Devocionais: Clóvis</option>
                                <option value="Louvor">Louvor: Mozer / Andrei / Nicoly E</option>
                                <option value="CoberturaEspiritual">Cobertura Espiritual</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editTaskTitle">Título da Tarefa</label>
                            <input type="text" class="form-control" id="editTaskTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="editTaskDescription">Descrição</label>
                            <textarea class="form-control" id="editTaskDescription" rows="3"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="editTaskDueDate">Data de Vencimento</label>
                                <input type="date" class="form-control" id="editTaskDueDate" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="editTaskPriority">Prioridade</label>
                                <select class="form-control" id="editTaskPriority">
                                    <option value="low">Baixa</option>
                                    <option value="medium">Média</option>
                                    <option value="high">Alta</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editTaskResponsible">Responsável</label>
                            <select class="form-control" id="editTaskResponsible">
                                <option value="">Selecione um responsável</option>
                                <option value="Mozer">Mozer</option>
                                <option value="Marcielle">Marcielle</option>
                                <option value="Ana Clara">Ana Clara</option>
                                <option value="Monique">Monique</option>
                                <option value="Rebekah">Rebekah</option>
                                <option value="Lívia">Lívia</option>
                                <option value="Pedro">Pedro</option>
                                <option value="Felipe">Felipe</option>
                                <option value="Amanda">Amanda</option>
                                <option value="Pietra">Pietra</option>
                                <option value="Lucas">Lucas</option>
                                <option value="Saymon">Saymon</option>
                                <option value="Clóvis">Clóvis</option>
                                <option value="Andrei">Andrei</option>
                                <option value="Nicoly E">Nicoly E</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editTaskStatus">Status</label>
                            <select class="form-control" id="editTaskStatus">
                                <option value="todo">A Fazer</option>
                                <option value="inProgress">Em Andamento</option>
                                <option value="completed">Concluído</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="updateTaskBtn">Atualizar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes da Tarefa -->
    <div class="modal fade" id="taskDetailModal" tabindex="-1" role="dialog" aria-labelledby="taskDetailModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskDetailModalLabel">Detalhes da Tarefa</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h4 id="detailTitle"></h4>
                            <p class="lead" id="detailDescription"></p>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">Informações</div>
                                <div class="card-body">
                                    <p><strong>Departamento:</strong> <span id="detailDepartment"></span></p>
                                    <p><strong>Responsável:</strong> <span id="detailResponsible"></span></p>
                                    <p><strong>Vencimento:</strong> <span id="detailDueDate"></span></p>
                                    <p><strong>Prioridade:</strong> <span id="detailPriority"></span></p>
                                    <p><strong>Status:</strong> <span id="detailStatus"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-info" id="editTaskBtn">Editar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC31C1X13eqVAOq_o5K2evI8q3GOfnpOpo",
            authDomain: "iebi-2e84e.firebaseapp.com",
            projectId: "iebi-2e84e",
            storageBucket: "iebi-2e84e.appspot.com",
            messagingSenderId: "634456198202",
            appId: "1:634456198202:web:8b4de1b4def23a49303903"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Variáveis globais
        let totalTarefas = 0;
        let tarefasConcluidas = 0;
        let tarefasPendentes = [];
        let tarefasAtrasadas = 0;
        let departamentos = {};
        let dataTable;

        // Função para alternar entre as abas
        $(document).ready(function () {
            $('.list-group-item').on('click', function (e) {
                e.preventDefault();

                // Remover classe active de todos os itens
                $('.list-group-item').removeClass('active');

                // Adicionar classe active ao item clicado
                $(this).addClass('active');

                // Obter a seção a ser exibida
                const section = $(this).data('section');

                // Esconder todas as seções
                $('.content-section').removeClass('active');

                // Mostrar a seção correspondente
                $('#' + section).addClass('active');

                // Se for a seção de checklist, inicializar DataTable
                if (section === 'checklist' && !dataTable) {
                    inicializarDataTable();
                }
            });

            // Botão "Ver todas as tarefas"
            $('#verTodasTarefas').on('click', function (e) {
                e.preventDefault();
                $('.list-group-item[data-section="checklist"]').click();
            });

            // Carregar dados do dashboard ao iniciar
            carregarDadosDashboard();
        });

        // Inicializar DataTable
        function inicializarDataTable() {
            dataTable = $('#tarefasTable').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/pt-BR.json'
                },
                responsive: true,
                columns: [
                    { data: 'titulo' },
                    { data: 'departamento' },
                    { data: 'responsavel' },
                    { data: 'vencimento' },
                    { data: 'prioridade' },
                    { data: 'status' },
                    { data: 'acoes' }
                ]
            });

            carregarTarefasTable();
        }

        // Função para carregar dados do dashboard
        function carregarDadosDashboard() {
            // Limpar os dados anteriores
            totalTarefas = 0;
            tarefasConcluidas = 0;
            tarefasPendentes = [];
            tarefasAtrasadas = 0;
            departamentos = {};

            // Buscar tarefas do Firestore
            db.collection("Acampamentos").doc("AcampBT2025").collection("checklist")
                .get()
                .then((querySnapshot) => {
                    const hoje = new Date();

                    querySnapshot.forEach((doc) => {
                        const tarefa = doc.data();
                        totalTarefas++;

                        // Verificar se a tarefa está concluída
                        if (tarefa.status === "completed") {
                            tarefasConcluidas++;
                        }

                        // Verificar se a tarefa está atrasada
                        const dataVencimento = new Date(tarefa.dataVencimento);
                        if (dataVencimento < hoje && tarefa.status !== "completed") {
                            tarefasAtrasadas++;
                        }

                        // Adicionar à lista de pendentes se não estiver concluída
                        if (tarefa.status !== "completed") {
                            tarefasPendentes.push({
                                id: doc.id,
                                titulo: tarefa.titulo,
                                departamento: tarefa.departamento,
                                dataVencimento: dataVencimento,
                                prioridade: tarefa.prioridade,
                                responsavel: tarefa.responsavel
                            });
                        }

                        // Contabilizar para as estatísticas de departamento
                        if (!departamentos[tarefa.departamento]) {
                            departamentos[tarefa.departamento] = {
                                total: 0,
                                concluidas: 0
                            };
                        }

                        departamentos[tarefa.departamento].total++;
                        if (tarefa.status === "completed") {
                            departamentos[tarefa.departamento].concluidas++;
                        }
                    });

                    // Atualizar a interface com os dados processados
                    atualizarInterfaceDashboard();
                })
                .catch((error) => {
                    console.error("Erro ao carregar tarefas: ", error);
                });
        }

        // Função para atualizar a interface do dashboard
        function atualizarInterfaceDashboard() {
            // Atualizar contadores
            document.getElementById('totalTarefas').textContent = totalTarefas;
            document.getElementById('tarefasConcluidas').textContent = tarefasConcluidas;
            document.getElementById('tarefasAtrasadas').textContent = tarefasAtrasadas;

            // Calcular progresso geral
            const porcentagemConcluida = totalTarefas > 0 ? Math.round((tarefasConcluidas / totalTarefas) * 100) : 0;
            const progressBar = document.getElementById('progressoGeral');
            progressBar.style.width = porcentagemConcluida + '%';
            progressBar.textContent = porcentagemConcluida + '% Concluído';
            progressBar.setAttribute('aria-valuenow', porcentagemConcluida);

            // Atualizar lista de departamentos
            const listaDepartamentos = document.getElementById('listaDepartamentos');
            listaDepartamentos.innerHTML = '';

            for (const [nome, stats] of Object.entries(departamentos)) {
                const porcentagem = stats.total > 0 ? Math.round((stats.concluidas / stats.total) * 100) : 0;
                let badgeClass = 'badge-danger';

                if (porcentagem >= 70) {
                    badgeClass = 'badge-success';
                } else if (porcentagem >= 40) {
                    badgeClass = 'badge-warning';
                } else if (porcentagem >= 10) {
                    badgeClass = 'badge-info';
                }

                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    ${nome}
                    <span class="badge ${badgeClass} badge-pill">${porcentagem}%</span>
                `;
                listaDepartamentos.appendChild(li);
            }

            // Ordenar tarefas pendentes por prioridade e data
            tarefasPendentes.sort((a, b) => {
                const prioridadeOrdem = { high: 1, medium: 2, low: 3 };
                // Primeiro por prioridade
                const compPrioridade = prioridadeOrdem[a.prioridade] - prioridadeOrdem[b.prioridade];
                // Se mesma prioridade, ordena por data
                return compPrioridade !== 0 ? compPrioridade : a.dataVencimento - b.dataVencimento;
            });

            // Limitar a 5 tarefas
            const tarefasExibir = tarefasPendentes.slice(0, 5);

            // Atualizar lista de tarefas pendentes
            const listaTarefasPendentes = document.getElementById('listaTarefasPendentes');
            listaTarefasPendentes.innerHTML = '';

            if (tarefasExibir.length === 0) {
                const li = document.createElement('li');
                li.className = 'list-group-item text-center';
                li.textContent = 'Não há tarefas pendentes';
                listaTarefasPendentes.appendChild(li);
            } else {
                tarefasExibir.forEach(tarefa => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';

                    // Determinar a classe de prioridade
                    let priorityClass = '';
                    let priorityText = '';

                    if (tarefa.prioridade === 'high') {
                        priorityClass = 'text-danger';
                        priorityText = 'Alta';
                    } else if (tarefa.prioridade === 'medium') {
                        priorityClass = 'text-warning';
                        priorityText = 'Média';
                    } else {
                        priorityClass = 'text-info';
                        priorityText = 'Baixa';
                    }

                    // Formatar data de vencimento
                    const dataFormatada = tarefa.dataVencimento.toLocaleDateString('pt-BR');

                    // Criar HTML para a tarefa
                    li.innerHTML = `
                        <div class="form-check">
                            <input class="form-check-input task-checkbox" type="checkbox" value="${tarefa.id}" id="task${tarefa.id}">
                            <label class="form-check-label" for="task${tarefa.id}">
                                <strong>${tarefa.titulo}</strong>
                                <span class="badge badge-secondary ml-2">${tarefa.departamento}</span>
                                <span class="ml-2 ${priorityClass}">Prioridade: ${priorityText}</span>
                                <br>
                                <small class="text-muted">Vencimento: ${dataFormatada}</small>
                            </label>
                        </div>
                    `;

                    listaTarefasPendentes.appendChild(li);

                    // Adicionar event listener para marcar como concluída
                    const checkbox = li.querySelector('.task-checkbox');
                    checkbox.addEventListener('change', function () {
                        if (this.checked) {
                            marcarComoConcluida(tarefa.id);
                        }
                    });
                });
            }
        }

        // Função para carregar tarefas na tabela
        function carregarTarefasTable() {
            // Limpar tabela
            dataTable.clear();

            // Buscar tarefas do Firestore
            db.collection("Acampamentos").doc("AcampBT2025").collection("checklist")
                .get()
                .then((querySnapshot) => {
                    let tarefas = [];

                    querySnapshot.forEach((doc) => {
                        const tarefa = doc.data();
                        const dataVencimento = new Date(tarefa.dataVencimento);

                        // Traduzir status
                        let statusTexto = '';
                        let statusBadge = '';

                        if (tarefa.status === 'todo') {
                            statusTexto = 'A Fazer';
                            statusBadge = 'badge-secondary';
                        } else if (tarefa.status === 'inProgress') {
                            statusTexto = 'Em Andamento';
                            statusBadge = 'badge-primary';
                        } else if (tarefa.status === 'completed') {
                            statusTexto = 'Concluído';
                            statusBadge = 'badge-success';
                        }

                        // Traduzir prioridade
                        let prioridadeTexto = '';
                        let prioridadeBadge = '';

                        if (tarefa.prioridade === 'high') {
                            prioridadeTexto = 'Alta';
                            prioridadeBadge = 'badge-high';
                        } else if (tarefa.prioridade === 'medium') {
                            prioridadeTexto = 'Média';
                            prioridadeBadge = 'badge-medium';
                        } else if (tarefa.prioridade === 'low') {
                            prioridadeTexto = 'Baixa';
                            prioridadeBadge = 'badge-low';
                        }

                        // Adicionar à lista
                        tarefas.push({
                            id: doc.id,
                            titulo: tarefa.titulo,
                            departamento: `<span class="badge badge-secondary">${tarefa.departamento}</span>`,
                            responsavel: tarefa.responsavel || 'Não atribuído',
                            vencimento: dataVencimento.toLocaleDateString('pt-BR'),
                            prioridade: `<span class="badge ${prioridadeBadge}">${prioridadeTexto}</span>`,
                            status: `<span class="badge ${statusBadge}">${statusTexto}</span>`,
                            acoes: `
                                <button class="btn btn-sm btn-info view-task" data-id="${doc.id}"><i class="bi bi-eye"></i></button>
                                <button class="btn btn-sm btn-primary edit-task" data-id="${doc.id}"><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-sm btn-danger delete-task" data-id="${doc.id}"><i class="bi bi-trash"></i></button>
                            `
                        });
                    });

                    // Adicionar dados à tabela
                    dataTable.rows.add(tarefas).draw();

                    // Adicionar event listeners para os botões de ação
                    adicionarEventListenersBotoes();
                })
                .catch((error) => {
                    console.error("Erro ao carregar tarefas: ", error);
                });
        }

        // Função para adicionar event listeners aos botões
        function adicionarEventListenersBotoes() {
            // Botão de visualizar tarefa
            $('#tarefasTable').on('click', '.view-task', function () {
                const id = $(this).data('id');
                abrirModalDetalhes(id);
            });

            // Botão de editar tarefa
            $('#tarefasTable').on('click', '.edit-task', function () {
                const id = $(this).data('id');
                abrirModalEdicao(id);
            });

            // Botão de excluir tarefa
            $('#tarefasTable').on('click', '.delete-task', function () {
                const id = $(this).data('id');
                excluirTarefa(id);
            });
        }

        // Função para marcar uma tarefa como concluída
        function marcarComoConcluida(id) {
            db.collection("Acampamentos").doc("AcampBT2025").collection("checklist").doc(id).update({
                status: "completed",
                dataAtualizacao: new Date().toISOString()
            })
                .then(() => {
                    console.log("Tarefa marcada como concluída!");
                    // Recarregar os dados do dashboard
                    carregarDadosDashboard();
                    // Se a tabela já foi inicializada, recarregar
                    if (dataTable) {
                        carregarTarefasTable();
                    }
                })
                .catch((error) => {
                    console.error("Erro ao marcar tarefa como concluída: ", error);
                    alert("Erro ao marcar tarefa como concluída. Tente novamente.");
                });
        }

        // Função para abrir modal de detalhes
        function abrirModalDetalhes(id) {
            db.collection("Acampamentos").doc("AcampBT2025").collection("checklist").doc(id)
                .get()
                .then((doc) => {
                    if (doc.exists) {
                        const tarefa = doc.data();

                        // Preencher dados no modal
                        document.getElementById('detailTitle').textContent = tarefa.titulo;
                        document.getElementById('detailDescription').textContent = tarefa.descricao || 'Sem descrição';
                        document.getElementById('detailDepartment').textContent = tarefa.departamento;
                        document.getElementById('detailResponsible').textContent = tarefa.responsavel || 'Não atribuído';

                        // Formatar data
                        const dataVencimento = new Date(tarefa.dataVencimento);
                        document.getElementById('detailDueDate').textContent = dataVencimento.toLocaleDateString('pt-BR');

                        // Traduzir prioridade
                        let prioridadeTexto = '';
                        if (tarefa.prioridade === 'high') {
                            prioridadeTexto = '<span class="text-danger">Alta</span>';
                        } else if (tarefa.prioridade === 'medium') {
                            prioridadeTexto = '<span class="text-warning">Média</span>';
                        } else {
                            prioridadeTexto = '<span class="text-info">Baixa</span>';
                        }
                        document.getElementById('detailPriority').innerHTML = prioridadeTexto;

                        // Traduzir status
                        let statusTexto = '';
                        if (tarefa.status === 'todo') {
                            statusTexto = '<span class="badge badge-secondary">A Fazer</span>';
                        } else if (tarefa.status === 'inProgress') {
                            statusTexto = '<span class="badge badge-primary">Em Andamento</span>';
                        } else if (tarefa.status === 'completed') {
                            statusTexto = '<span class="badge badge-success">Concluído</span>';
                        }
                        document.getElementById('detailStatus').innerHTML = statusTexto;

                        // Adicionar ID ao botão editar
                        document.getElementById('editTaskBtn').setAttribute('data-id', id);

                        // Abrir o modal
                        $('#taskDetailModal').modal('show');
                    }
                })
                .catch((error) => {
                    console.error("Erro ao buscar detalhes da tarefa: ", error);
                });
        }

        // Função para abrir modal de edição
        function abrirModalEdicao(id) {
            db.collection("Acampamentos").doc("AcampBT2025").collection("checklist").doc(id)
                .get()
                .then((doc) => {
                    if (doc.exists) {
                        const tarefa = doc.data();

                        // Preencher campos do formulário
                        document.getElementById('editTaskId').value = id;
                        document.getElementById('editTaskDepartment').value = tarefa.departamento;
                        document.getElementById('editTaskTitle').value = tarefa.titulo;
                        document.getElementById('editTaskDescription').value = tarefa.descricao || '';
                        document.getElementById('editTaskResponsible').value = tarefa.responsavel || '';
                        document.getElementById('editTaskStatus').value = tarefa.status;
                        document.getElementById('editTaskPriority').value = tarefa.prioridade;

                        // Formatar a data para o padrão YYYY-MM-DD
                        const dataVencimento = tarefa.dataVencimento.split('T')[0];
                        document.getElementById('editTaskDueDate').value = dataVencimento;

                        // Abrir o modal
                        $('#editTaskModal').modal('show');
                    }
                })
                .catch((error) => {
                    console.error("Erro ao buscar dados para edição: ", error);
                });
        }

        // Event listener para o botão de editar no modal de detalhes
        document.getElementById('editTaskBtn').addEventListener('click', function () {
            const id = this.getAttribute('data-id');

            // Usar o evento 'hidden.bs.modal' para garantir sequência correta
            $('#taskDetailModal').on('hidden.bs.modal', function () {
                // Remove o event listener para evitar múltiplas chamadas
                $('#taskDetailModal').off('hidden.bs.modal');
                // Pequeno delay para garantir que o DOM foi atualizado
                setTimeout(function () {
                    abrirModalEdicao(id);
                }, 100);
            });

            // Inicia o fechamento do modal
            $('#taskDetailModal').modal('hide');
        });


        // Função para salvar nova tarefa
        document.getElementById('saveTaskBtn').addEventListener('click', function () {
            const taskDepartment = document.getElementById('taskDepartment').value;
            const taskTitle = document.getElementById('taskTitle').value;
            const taskDescription = document.getElementById('taskDescription').value;
            const taskDueDate = document.getElementById('taskDueDate').value;
            const taskPriority = document.getElementById('taskPriority').value;
            const taskResponsible = document.getElementById('taskResponsible').value;

            if (!taskTitle || !taskDueDate || !taskDepartment) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }

            // Adicionar ao Firestore
            db.collection("Acampamentos").doc("AcampBT2025").collection("checklist").add({
                departamento: taskDepartment,
                titulo: taskTitle,
                descricao: taskDescription,
                dataVencimento: taskDueDate,
                prioridade: taskPriority,
                responsavel: taskResponsible,
                status: "todo",
                dataCriacao: new Date().toISOString(),
                dataAtualizacao: new Date().toISOString()
            })
                .then(() => {
                    console.log("Tarefa adicionada com sucesso!");
                    $('#addTaskModal').modal('hide');
                    document.getElementById('newTaskForm').reset();

                    // Recarregar dados
                    carregarDadosDashboard();
                    if (dataTable) {
                        carregarTarefasTable();
                    }
                })
                .catch((error) => {
                    console.error("Erro ao adicionar tarefa: ", error);
                    alert("Erro ao adicionar tarefa. Tente novamente.");
                });
        });

        // Função para atualizar tarefa
        document.getElementById('updateTaskBtn').addEventListener('click', function () {
            const taskId = document.getElementById('editTaskId').value;
            const taskDepartment = document.getElementById('editTaskDepartment').value;
            const taskTitle = document.getElementById('editTaskTitle').value;
            const taskDescription = document.getElementById('editTaskDescription').value;
            const taskDueDate = document.getElementById('editTaskDueDate').value;
            const taskPriority = document.getElementById('editTaskPriority').value;
            const taskResponsible = document.getElementById('editTaskResponsible').value;
            const taskStatus = document.getElementById('editTaskStatus').value;

            if (!taskTitle || !taskDueDate || !taskDepartment) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }

            // Atualizar no Firestore
            db.collection("Acampamentos").doc("AcampBT2025").collection("checklist").doc(taskId).update({
                departamento: taskDepartment,
                titulo: taskTitle,
                descricao: taskDescription,
                dataVencimento: taskDueDate,
                prioridade: taskPriority,
                responsavel: taskResponsible,
                status: taskStatus,
                dataAtualizacao: new Date().toISOString()
            })
                .then(() => {
                    console.log("Tarefa atualizada com sucesso!");
                    $('#editTaskModal').modal('hide');

                    // Recarregar dados
                    carregarDadosDashboard();
                    if (dataTable) {
                        carregarTarefasTable();
                    }
                })
                .catch((error) => {
                    console.error("Erro ao atualizar tarefa: ", error);
                    alert("Erro ao atualizar tarefa. Tente novamente.");
                });
        });

        // Função para excluir tarefa
        function excluirTarefa(id) {
            const confirmar = confirm("Tem certeza que deseja excluir esta tarefa?");
            if (confirmar) {
                db.collection("Acampamentos").doc("AcampBT2025").collection("checklist").doc(id).delete()
                    .then(() => {
                        console.log("Tarefa excluída com sucesso!");

                        // Recarregar dados
                        carregarDadosDashboard();
                        if (dataTable) {
                            carregarTarefasTable();
                        }
                    })
                    .catch((error) => {
                        console.error("Erro ao excluir tarefa: ", error);
                        alert("Erro ao excluir tarefa. Tente novamente.");
                    });
            }
        }

        // Filtrar tarefas na tabela
        $('#filterForm').on('submit', function (e) {
            e.preventDefault();
            aplicarFiltros();
        });

        $('#limparFiltro').on('click', function () {
            document.getElementById('filterForm').reset();
            aplicarFiltros();
        });

        function aplicarFiltros() {
            const filtroDepartamento = document.getElementById('filterDepartamento').value;
            const filtroStatus = document.getElementById('filterStatus').value;
            const filtroPrioridade = document.getElementById('filterPrioridade').value;

            // Limpar filtros anteriores
            dataTable.search('').columns().search('').draw();

            // Aplicar filtros
            if (filtroDepartamento) {
                dataTable.column(1).search(filtroDepartamento).draw();
            }

            if (filtroStatus) {
                let textoStatus = '';
                if (filtroStatus === 'todo') textoStatus = 'A Fazer';
                if (filtroStatus === 'inProgress') textoStatus = 'Em Andamento';
                if (filtroStatus === 'completed') textoStatus = 'Concluído';

                dataTable.column(5).search(textoStatus).draw();
            }

            if (filtroPrioridade) {
                let textoPrioridade = '';
                if (filtroPrioridade === 'high') textoPrioridade = 'Alta';
                if (filtroPrioridade === 'medium') textoPrioridade = 'Média';
                if (filtroPrioridade === 'low') textoPrioridade = 'Baixa';

                dataTable.column(4).search(textoPrioridade).draw();
            }
        }
    </script>
</body>

</html>